{% extends 'base.html' %}
{% load static %}

{% block title %}API Reference - EdgeSync Documentation{% endblock %}

{% block meta_description %}Complete API documentation for EdgeSync IoT platform. Learn how to integrate with REST APIs, WebSocket connections, and authentication methods.{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/docs.css' %}">
{% endblock %}

{% block content %}
<div class="docs-layout">
    <!-- Sidebar Navigation -->
    <aside class="docs-sidebar">
        <h3>API Reference</h3>
        <ul class="docs-nav">
            <li><a href="#overview" class="active">API Overview</a></li>
            <li><a href="#authentication">Authentication</a></li>
            <li><a href="#rest-endpoints">REST Endpoints</a></li>
            <li><a href="#websocket">WebSocket API</a></li>
            <li><a href="#mqtt">MQTT Broker</a></li>
            <li><a href="#sdks">SDKs & Libraries</a></li>
            <li><a href="#rate-limits">Rate Limits</a></li>
            <li><a href="#errors">Error Handling</a></li>
        </ul>
        
        <h3>Other Sections</h3>
        <ul class="docs-nav">
            <li><a href="{% url 'docs_getting_started' %}">Getting Started</a></li>
            <li><a href="{% url 'docs_tutorials' %}">Tutorials & Guides</a></li>
            <li><a href="{% url 'docs_best_practices' %}">Best Practices</a></li>
        </ul>
    </aside>

    <!-- Main Content -->
    <main class="docs-content">
        <h1>EdgeSync API Reference</h1>
        <p>The EdgeSync API provides programmatic access to all platform features, enabling you to build custom applications, integrate with existing systems, and automate IoT workflows.</p>

        <h2 id="overview">API Overview</h2>
        <p>EdgeSync offers multiple API interfaces to suit different use cases:</p>
        <ul>
            <li><strong>REST API</strong> - Standard HTTP-based API for device management and data access</li>
            <li><strong>WebSocket API</strong> - Real-time bidirectional communication</li>
            <li><strong>MQTT Broker</strong> - Lightweight messaging protocol for IoT devices</li>
            <li><strong>GraphQL API</strong> - Flexible query language for complex data operations</li>
        </ul>

        <div class="alert info">
            <strong>Base URL:</strong> All API endpoints are relative to <code>https://api.edgesync.com/v1</code>
        </div>

        <h2 id="authentication">Authentication</h2>
        <p>EdgeSync uses API keys and OAuth 2.0 for authentication. All API requests must include proper authentication headers.</p>

        <h3>API Key Authentication</h3>
        <p>Include your API key in the Authorization header:</p>
        <pre><code>curl -H "Authorization: Bearer YOUR_API_KEY" \
     -H "Content-Type: application/json" \
     https://api.edgesync.com/v1/devices
</code></pre>

        <h3>OAuth 2.0 Flow</h3>
        <p>For user-based authentication, use the OAuth 2.0 authorization code flow:</p>
        <pre><code>// Step 1: Redirect user to authorization URL
const authUrl = 'https://auth.edgesync.com/oauth/authorize?' +
    'client_id=YOUR_CLIENT_ID&' +
    'response_type=code&' +
    'scope=read:devices write:devices&' +
    'redirect_uri=YOUR_REDIRECT_URI';

// Step 2: Exchange authorization code for access token
const tokenResponse = await fetch('https://auth.edgesync.com/oauth/token', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
        grant_type: 'authorization_code',
        client_id: 'YOUR_CLIENT_ID',
        client_secret: 'YOUR_CLIENT_SECRET',
        code: 'AUTHORIZATION_CODE',
        redirect_uri: 'YOUR_REDIRECT_URI'
    })
});
</code></pre>

        <h2 id="rest-endpoints">REST Endpoints</h2>
        <p>The REST API provides access to all EdgeSync resources through standard HTTP methods.</p>

        <h3>Devices</h3>
        <h4>List Devices</h4>
        <pre><code>GET /devices

Response:
{
    "devices": [
        {
            "id": "device-123",
            "name": "Temperature Sensor 1",
            "type": "ESP32",
            "status": "online",
            "lastSeen": "2024-01-15T10:30:00Z",
            "metadata": {
                "location": "Building A, Floor 2",
                "firmware": "1.2.3"
            }
        }
    ],
    "pagination": {
        "page": 1,
        "limit": 50,
        "total": 150
    }
}
</code></pre>

        <h4>Create Device</h4>
        <pre><code>POST /devices

Request:
{
    "name": "New Temperature Sensor",
    "type": "ESP32",
    "metadata": {
        "location": "Building B, Floor 1"
    }
}

Response:
{
    "id": "device-456",
    "name": "New Temperature Sensor",
    "type": "ESP32",
    "status": "offline",
    "credentials": {
        "deviceId": "device-456",
        "certificateArn": "arn:aws:iot:us-east-1:123456789:cert/abc123",
        "privateKey": "-----BEGIN PRIVATE KEY-----...",
        "certificate": "-----BEGIN CERTIFICATE-----..."
    }
}
</code></pre>

        <h4>Get Device Details</h4>
        <pre><code>GET /devices/{deviceId}

Response:
{
    "id": "device-123",
    "name": "Temperature Sensor 1",
    "type": "ESP32",
    "status": "online",
    "lastSeen": "2024-01-15T10:30:00Z",
    "telemetry": {
        "temperature": 23.5,
        "humidity": 65.2,
        "timestamp": "2024-01-15T10:30:00Z"
    },
    "metadata": {
        "location": "Building A, Floor 2",
        "firmware": "1.2.3"
    }
}
</code></pre>

        <h3>Data & Analytics</h3>
        <h4>Query Telemetry Data</h4>
        <pre><code>GET /devices/{deviceId}/telemetry?start=2024-01-01&end=2024-01-15&fields=temperature,humidity

Response:
{
    "data": [
        {
            "timestamp": "2024-01-15T10:00:00Z",
            "temperature": 23.1,
            "humidity": 64.8
        },
        {
            "timestamp": "2024-01-15T10:30:00Z",
            "temperature": 23.5,
            "humidity": 65.2
        }
    ],
    "aggregation": {
        "avg_temperature": 23.3,
        "max_temperature": 25.1,
        "min_temperature": 21.8
    }
}
</code></pre>

        <h3>Projects & Organizations</h3>
        <h4>List Projects</h4>
        <pre><code>GET /projects

Response:
{
    "projects": [
        {
            "id": "project-789",
            "name": "Smart Building Monitoring",
            "description": "IoT sensors for building automation",
            "deviceCount": 25,
            "createdAt": "2024-01-01T00:00:00Z"
        }
    ]
}
</code></pre>

        <h2 id="websocket">WebSocket API</h2>
        <p>Use WebSocket connections for real-time data streaming and bidirectional communication.</p>

        <h3>Connection</h3>
        <pre><code>// Connect to WebSocket
const ws = new WebSocket('wss://ws.edgesync.com/v1/stream');

// Authentication
ws.onopen = function() {
    ws.send(JSON.stringify({
        type: 'auth',
        token: 'YOUR_ACCESS_TOKEN'
    }));
};

// Subscribe to device data
ws.send(JSON.stringify({
    type: 'subscribe',
    channel: 'device:device-123:telemetry'
}));

// Handle incoming messages
ws.onmessage = function(event) {
    const message = JSON.parse(event.data);
    console.log('Received:', message);
};
</code></pre>

        <h3>Message Types</h3>
        <pre><code>// Telemetry data
{
    "type": "telemetry",
    "deviceId": "device-123",
    "timestamp": "2024-01-15T10:30:00Z",
    "data": {
        "temperature": 23.5,
        "humidity": 65.2
    }
}

// Device status change
{
    "type": "status",
    "deviceId": "device-123",
    "status": "online",
    "timestamp": "2024-01-15T10:30:00Z"
}

// Command acknowledgment
{
    "type": "command_ack",
    "deviceId": "device-123",
    "commandId": "cmd-456",
    "status": "success",
    "timestamp": "2024-01-15T10:30:00Z"
}
</code></pre>

        <h2 id="mqtt">MQTT Broker</h2>
        <p>EdgeSync provides a managed MQTT broker for device communication with support for MQTT v3.1, v3.1.1, and v5.0.</p>

        <h3>Connection Details</h3>
        <pre><code>// MQTT Connection Parameters
Host: mqtt.edgesync.com
Port: 8883 (TLS/SSL)
Port: 1883 (Non-encrypted, development only)

// Authentication
Username: device-id
Password: device-token

// TLS Configuration
CA Certificate: Download from device credentials
Client Certificate: Device-specific certificate
Private Key: Device-specific private key
</code></pre>

        <h3>Topic Structure</h3>
        <pre><code>// Telemetry (device to cloud)
devices/{deviceId}/telemetry

// Commands (cloud to device)
devices/{deviceId}/commands

// Status updates
devices/{deviceId}/status

// OTA updates
devices/{deviceId}/ota

// Custom topics
projects/{projectId}/custom/{topic}
</code></pre>

        <h3>Message Examples</h3>
        <pre><code>// Telemetry message
Topic: devices/esp32-001/telemetry
Payload: {
    "timestamp": "2024-01-15T10:30:00Z",
    "temperature": 23.5,
    "humidity": 65.2,
    "battery": 87
}

// Command message
Topic: devices/esp32-001/commands
Payload: {
    "commandId": "cmd-123",
    "type": "setThreshold",
    "parameters": {
        "temperature": 25.0
    }
}
</code></pre>

        <h2 id="sdks">SDKs & Libraries</h2>
        <p>EdgeSync provides official SDKs for popular programming languages:</p>

        <h3>JavaScript/Node.js</h3>
        <pre><code>npm install @edgesync/sdk

// Usage
import { EdgeSyncClient } from '@edgesync/sdk';

const client = new EdgeSyncClient({
    apiKey: 'your-api-key',
    region: 'us-east-1'
});

// List devices
const devices = await client.devices.list();

// Subscribe to real-time data
client.realtime.subscribe('device:123:telemetry', (data) => {
    console.log('Telemetry:', data);
});
</code></pre>

        <h3>Python</h3>
        <pre><code>pip install edgesync-python

# Usage
from edgesync import EdgeSyncClient

client = EdgeSyncClient(
    api_key='your-api-key',
    region='us-east-1'
)

# List devices
devices = client.devices.list()

# Query telemetry data
data = client.telemetry.query(
    device_id='device-123',
    start='2024-01-01',
    end='2024-01-15'
)
</code></pre>

        <h2 id="rate-limits">Rate Limits</h2>
        <p>API requests are subject to rate limiting to ensure fair usage:</p>
        <ul>
            <li><strong>REST API:</strong> 1000 requests per minute per API key</li>
            <li><strong>WebSocket:</strong> 100 connections per account</li>
            <li><strong>MQTT:</strong> 1000 messages per second per device</li>
        </ul>

        <div class="alert warning">
            <strong>Rate Limit Headers:</strong> Check response headers for current rate limit status:
            <ul>
                <li><code>X-RateLimit-Limit</code> - Request limit per window</li>
                <li><code>X-RateLimit-Remaining</code> - Remaining requests</li>
                <li><code>X-RateLimit-Reset</code> - Window reset time</li>
            </ul>
        </div>

        <h2 id="errors">Error Handling</h2>
        <p>EdgeSync APIs use standard HTTP status codes and provide detailed error information:</p>

        <h3>Error Response Format</h3>
        <pre><code>{
    "error": {
        "code": "DEVICE_NOT_FOUND",
        "message": "Device with ID 'device-123' not found",
        "details": {
            "deviceId": "device-123",
            "suggestion": "Check device ID and ensure it exists in your project"
        }
    }
}
</code></pre>

        <h3>Common Error Codes</h3>
        <ul>
            <li><strong>400 Bad Request:</strong> Invalid request parameters</li>
            <li><strong>401 Unauthorized:</strong> Missing or invalid authentication</li>
            <li><strong>403 Forbidden:</strong> Insufficient permissions</li>
            <li><strong>404 Not Found:</strong> Resource not found</li>
            <li><strong>429 Too Many Requests:</strong> Rate limit exceeded</li>
            <li><strong>500 Internal Server Error:</strong> Server error</li>
        </ul>
    </main>

    <!-- Table of Contents -->
    <aside class="docs-toc">
        <h4>On This Page</h4>
        <ul class="toc-list">
            <!-- TOC will be generated by JavaScript -->
        </ul>
    </aside>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/docs.js' %}"></script>
{% endblock %}
