{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🔌 Device Registration - EdgeSync</title>
    <link rel="stylesheet" href="{% static 'css/base.css' %}">
    <link rel="stylesheet" href="{% static 'css/device_registration.css' %}">
</head>
<body>
    <div class="main-container">
        <nav class="navbar">
            <div class="nav-brand">
                <h2>🔌 EdgeSync Device Management</h2>
            </div>
            <div class="nav-links">
                <a href="/dashboard/" class="nav-link">📊 Dashboard</a>
                <a href="/devices/" class="nav-link active">🔌 Devices</a>
                {% if user.is_authenticated %}
                <div class="user-section">
                    <span class="user-info">{{ user.email|default:user.username }}</span>
                    <button onclick="confirmLogout()" class="logout-btn">Logout</button>
                </div>
                {% endif %}
            </div>
        </nav>

        <div class="page-content">
            <div class="header">
                <h1>🔌 IoT Device Registration</h1>
                <p>Register and manage your MQTT-enabled IoT devices</p>
            </div>

        <div class="device-management">
            <!-- Device Registration Form -->
            <div class="card register-form">
                <div class="card-header">
                    <h3>📝 Register New Device</h3>
                </div>
                <form id="deviceRegistrationForm">
                    {% csrf_token %}
                    <div class="form-group">
                        <label for="deviceId">Device ID *</label>
                        <input type="text" id="deviceId" name="deviceId" required placeholder="e.g., sensor_001_temp">
                        <small>Unique identifier for your device</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="deviceName">Device Name *</label>
                        <input type="text" id="deviceName" name="deviceName" required placeholder="e.g., Temperature Sensor 1">
                    </div>
                    
                    <div class="form-group">
                        <label for="deviceType">Device Type *</label>
                        <select id="deviceType" name="deviceType" required>
                            <option value="">Select device type</option>
                            <option value="temperature_sensor">Temperature Sensor</option>
                            <option value="humidity_sensor">Humidity Sensor</option>
                            <option value="pressure_sensor">Pressure Sensor</option>
                            <option value="valve_actuator">Valve Actuator</option>
                            <option value="led_actuator">LED Actuator</option>
                            <option value="relay_actuator">Relay Actuator</option>
                            <option value="custom">Custom</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="tenantId">Tenant ID</label>
                        <input type="text" id="tenantId" name="tenantId" placeholder="Auto-generated" readonly>
                        <small>Will be auto-generated based on your account</small>
                    </div>
                    
                    <div class="form-group">
                        <h4>📡 MQTT Topic Configuration</h4>
                        <div class="topic-config">
                            <div class="topic-preview">
                                <strong>Topic Pattern:</strong> 
                                <code id="topicPreview">iot/[tenant]/[device_id]/data</code>
                            </div>
                            
                            <div class="permission-grid">
                                <div class="permission-item">
                                    <input type="checkbox" id="readPermission" name="permissions" value="read" checked>
                                    <label for="readPermission">📥 Read</label>
                                </div>
                                <div class="permission-item">
                                    <input type="checkbox" id="writePermission" name="permissions" value="write" checked>
                                    <label for="writePermission">📤 Write</label>
                                </div>
                                <div class="permission-item">
                                    <input type="checkbox" id="subscribePermission" name="permissions" value="subscribe" checked>
                                    <label for="subscribePermission">🔔 Subscribe</label>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-actions">
                        <button type="submit" class="btn-primary">🔌 Register Device</button>
                        <button type="reset" class="btn-secondary">🔄 Reset</button>
                    </div>
                </form>
            </div>

            <!-- Device List -->
            <div class="card device-list">
                <div class="card-header">
                    <h3>📋 Your Registered Devices</h3>
                    <div class="filters">
                        <select id="statusFilter">
                            <option value="">All Status</option>
                            <option value="active">Active</option>
                            <option value="inactive">Inactive</option>
                        </select>
                        <select id="typeFilter">
                            <option value="">All Types</option>
                            <option value="temperature_sensor">Temperature Sensor</option>
                            <option value="humidity_sensor">Humidity Sensor</option>
                            <option value="pressure_sensor">Pressure Sensor</option>
                            <option value="valve_actuator">Valve Actuator</option>
                            <option value="led_actuator">LED Actuator</option>
                            <option value="relay_actuator">Relay Actuator</option>
                        </select>
                    </div>
                </div>
                <div class="device-grid" id="deviceGrid">
                    <!-- Device cards will be populated by JavaScript -->
                </div>
            </div>

            <!-- MQTT Connection Info -->
            <div class="card mqtt-info">
                <div class="card-header">
                    <h3>🌐 MQTT Connection Information</h3>
                </div>
                <div class="mqtt-details">
                    <div class="mqtt-item">
                        <strong>MQTT Broker:</strong> 
                        <code>13.203.165.247</code>
                    </div>
                    <div class="mqtt-item">
                        <strong>Port:</strong> 
                        <code>1883</code> (MQTT) | <code>1884</code> (WebSocket)
                    </div>
                    <div class="mqtt-item">
                        <strong>Username:</strong> 
                        <div id="usernameSection">
                            <code id="mqttUsername">Not Set</code>
                            <input type="text" id="mqttUsernameInput" placeholder="Choose MQTT username" style="display: none; margin-left: 10px; padding: 8px; border-radius: 5px; border: 1px solid #ccc; max-width: 200px;">
                        </div>
                    </div>
                    <div class="mqtt-item">
                        <strong>Password:</strong> 
                        <div id="passwordSection">
                            <input type="password" id="mqttPasswordInput" placeholder="Enter MQTT password (min 8 chars)" style="display: none; margin-right: 10px; padding: 8px; border-radius: 5px; border: 1px solid #ccc; max-width: 200px;">
                            <button class="btn-small" id="setCredentialsBtn" onclick="showCredentialsInput()">🔐 Set MQTT Credentials</button>
                            <button class="btn-small" id="saveCredentialsBtn" onclick="setMqttCredentials()" style="display: none;">💾 Save Credentials</button>
                            <button class="btn-small" id="connectBtn" onclick="connectToMqtt()" style="display: none;">🔗 Connect to MQTT</button>
                            <span id="credentialsStatus" style="margin-left: 10px; font-weight: bold;"></span>
                        </div>
                    </div>
                    <div class="mqtt-item">
                        <strong>Connection Status:</strong> 
                        <span id="connectionStatus">Not Connected</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Device Details Modal -->
    <div id="deviceModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">Device Details</h3>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <div id="deviceDetails">
                    <!-- Device details will be populated by JavaScript -->
                </div>
                <div class="modal-actions">
                    <button class="btn-primary" onclick="editDevice()">✏️ Edit</button>
                    <button class="btn-danger" onclick="deleteDevice()">🗑️ Delete</button>
                    <button class="btn-secondary" onclick="closeModal()">❌ Close</button>
                </div>
            </div>
        </div>
    </div>

    <script src="{% static 'js/device_registration.js' %}"></script>
    <script>
        function confirmLogout() {
            if (confirm('Are you sure you want to logout?')) {
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = '{% url "account_logout" %}';
                
                const csrfToken = document.createElement('input');
                csrfToken.type = 'hidden';
                csrfToken.name = 'csrfmiddlewaretoken';
                csrfToken.value = '{{ csrf_token }}';
                form.appendChild(csrfToken);
                
                document.body.appendChild(form);
                form.submit();
            }
        }
    </script>
</body>
</html>