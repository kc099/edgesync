{% extends 'base.html' %}
{% load static %}

{% block title %}Best Practices - EdgeSync Documentation{% endblock %}

{% block meta_description %}Security guidelines, performance optimization, and best practices for building scalable and secure IoT solutions with EdgeSync platform.{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/docs.css' %}">
{% endblock %}

{% block content %}
<div class="docs-layout">
    <!-- Sidebar Navigation -->
    <aside class="docs-sidebar">
        <h3>Best Practices</h3>
        <ul class="docs-nav">
            <li><a href="#overview" class="active">Overview</a></li>
            <li><a href="#security">Security Guidelines</a></li>
            <li><a href="#performance">Performance Optimization</a></li>
            <li><a href="#scalability">Scalability Patterns</a></li>
            <li><a href="#monitoring">Monitoring & Alerting</a></li>
            <li><a href="#data-management">Data Management</a></li>
            <li><a href="#troubleshooting">Troubleshooting</a></li>
            <li><a href="#production">Production Deployment</a></li>
        </ul>
        
        <h3>Other Sections</h3>
        <ul class="docs-nav">
            <li><a href="{% url 'docs_getting_started' %}">Getting Started</a></li>
            <li><a href="{% url 'docs_api_reference' %}">API Reference</a></li>
            <li><a href="{% url 'docs_tutorials' %}">Tutorials & Guides</a></li>
        </ul>
    </aside>

    <!-- Main Content -->
    <main class="docs-content">
        <h1>Best Practices</h1>
        <p>Essential guidelines for building secure, scalable, and maintainable IoT solutions with EdgeSync. Follow these practices to ensure optimal performance and security in production environments.</p>

        <h2 id="overview">Overview</h2>
        <p>This guide covers critical areas for successful IoT deployments:</p>
        <ul>
            <li><strong>Security:</strong> Protect your devices and data</li>
            <li><strong>Performance:</strong> Optimize for speed and efficiency</li>
            <li><strong>Scalability:</strong> Design for growth</li>
            <li><strong>Reliability:</strong> Ensure system availability</li>
            <li><strong>Maintainability:</strong> Simplify operations and updates</li>
        </ul>

        <div class="alert info">
            <strong>Production Ready:</strong> These practices are essential for production deployments and should be implemented from the beginning of your project.
        </div>

        <h2 id="security">Security Guidelines</h2>
        <p>Security is paramount in IoT deployments. EdgeSync provides multiple layers of security, but proper implementation is crucial.</p>

        <h3>Device Authentication</h3>
        <h4>Certificate-Based Authentication</h4>
        <p>Always use certificate-based authentication for production devices:</p>
        <pre><code>// Secure device configuration
{
    "authentication": {
        "method": "certificate",
        "certificateArn": "arn:aws:iot:region:account:cert/certificate-id",
        "rotationPolicy": {
            "enabled": true,
            "intervalDays": 90
        }
    },
    "encryption": {
        "inTransit": "TLS 1.3",
        "atRest": "AES-256"
    }
}
</code></pre>

        <h4>Key Management Best Practices</h4>
        <ul>
            <li><strong>Unique Keys:</strong> Each device must have unique certificates and keys</li>
            <li><strong>Secure Storage:</strong> Store private keys in secure hardware (HSM/TPM)</li>
            <li><strong>Regular Rotation:</strong> Rotate certificates every 90 days</li>
            <li><strong>Revocation:</strong> Implement certificate revocation for compromised devices</li>
        </ul>

        <h3>Network Security</h3>
        <h4>MQTT Security Configuration</h4>
        <pre><code>// Secure MQTT broker configuration
{
    "broker": {
        "port": 8883,
        "protocol": "MQTTS",
        "tlsVersion": "1.3",
        "cipherSuites": [
            "TLS_AES_256_GCM_SHA384",
            "TLS_CHACHA20_POLY1305_SHA256"
        ]
    },
    "acl": {
        "defaultPolicy": "deny",
        "rules": [
            {
                "principal": "device:${iot:Connection.Thing.ThingName}",
                "action": "iot:Publish",
                "resource": "arn:aws:iot:*:*:topic/devices/${iot:Connection.Thing.ThingName}/*"
            }
        ]
    }
}
</code></pre>

        <h3>Data Protection</h3>
        <h4>Encryption Standards</h4>
        <ul>
            <li><strong>In Transit:</strong> TLS 1.3 for all communications</li>
            <li><strong>At Rest:</strong> AES-256 encryption for stored data</li>
            <li><strong>End-to-End:</strong> Application-level encryption for sensitive data</li>
        </ul>

        <h4>Data Classification</h4>
        <pre><code>// Data classification example
{
    "dataTypes": {
        "public": {
            "encryption": "none",
            "retention": "1y",
            "examples": ["device status", "firmware version"]
        },
        "internal": {
            "encryption": "AES-256",
            "retention": "3y",
            "examples": ["telemetry data", "usage metrics"]
        },
        "confidential": {
            "encryption": "AES-256 + application layer",
            "retention": "7y",
            "examples": ["user data", "location data"]
        }
    }
}
</code></pre>

        <h2 id="performance">Performance Optimization</h2>
        <p>Optimize your IoT deployment for maximum performance and efficiency.</p>

        <h3>Message Optimization</h3>
        <h4>Efficient Data Formats</h4>
        <p>Use compact data formats to reduce bandwidth and improve performance:</p>
        <pre><code>// Optimized telemetry message
{
    "ts": 1642248600,  // Unix timestamp (4 bytes vs 24 bytes for ISO string)
    "t": 23.5,         // Temperature (short field names)
    "h": 65.2,         // Humidity
    "b": 87,           // Battery level
    "s": 1             // Status (1=online, 0=offline)
}

// Alternative: Binary format for high-frequency data
// Struct: timestamp(4) + temp(2) + humidity(2) + battery(1) + status(1) = 10 bytes
// vs JSON: ~80 bytes
</code></pre>

        <h3>Connection Management</h3>
        <h4>MQTT Connection Optimization</h4>
        <pre><code>// Optimized MQTT client configuration
{
    "connection": {
        "keepAlive": 60,           // Seconds
        "cleanSession": false,     // Persistent sessions
        "qos": 1,                  // At least once delivery
        "retain": false,           // Don't retain messages
        "reconnectDelay": {
            "initial": 1000,       // 1 second
            "max": 30000,          // 30 seconds
            "multiplier": 2        // Exponential backoff
        }
    },
    "publishing": {
        "batchSize": 10,           // Batch multiple readings
        "maxInterval": 30000,      // Max 30 seconds between publishes
        "compression": "gzip"      // Compress large payloads
    }
}
</code></pre>

        <h3>Resource Management</h3>
        <h4>Device Resource Optimization</h4>
        <ul>
            <li><strong>Memory:</strong> Use circular buffers for data collection</li>
            <li><strong>CPU:</strong> Implement sleep modes between readings</li>
            <li><strong>Battery:</strong> Optimize transmission intervals</li>
            <li><strong>Storage:</strong> Implement local data compression</li>
        </ul>

        <h2 id="scalability">Scalability Patterns</h2>
        <p>Design your IoT solution to scale from hundreds to millions of devices.</p>

        <h3>Device Organization</h3>
        <h4>Hierarchical Device Groups</h4>
        <pre><code>// Scalable device organization
{
    "organization": "company-abc",
    "regions": [
        {
            "name": "us-east",
            "sites": [
                {
                    "name": "headquarters",
                    "buildings": [
                        {
                            "name": "building-a",
                            "floors": [
                                {
                                    "name": "floor-1",
                                    "zones": [
                                        {
                                            "name": "zone-north",
                                            "devices": ["temp-001", "humid-001"]
                                        }
                                    ]
                                }
                            ]
                        }
                    ]
                }
            ]
        }
    ]
}
</code></pre>

        <h3>Data Partitioning</h3>
        <h4>Time-Based Partitioning</h4>
        <pre><code>// Database partitioning strategy
{
    "partitioning": {
        "strategy": "time-based",
        "interval": "monthly",
        "retention": {
            "hot": "3 months",      // Fast SSD storage
            "warm": "12 months",    // Standard storage
            "cold": "7 years"       // Archive storage
        }
    },
    "indexing": {
        "primary": ["deviceId", "timestamp"],
        "secondary": ["location", "deviceType"]
    }
}
</code></pre>

        <h2 id="monitoring">Monitoring & Alerting</h2>
        <p>Implement comprehensive monitoring to ensure system health and performance.</p>

        <h3>Key Metrics</h3>
        <h4>Device Metrics</h4>
        <ul>
            <li><strong>Connectivity:</strong> Online/offline status, connection duration</li>
            <li><strong>Performance:</strong> Message latency, throughput, error rates</li>
            <li><strong>Health:</strong> Battery level, memory usage, CPU temperature</li>
            <li><strong>Security:</strong> Failed authentication attempts, certificate expiry</li>
        </ul>

        <h4>System Metrics</h4>
        <pre><code>// Monitoring configuration
{
    "metrics": {
        "device": {
            "connectionStatus": {
                "threshold": "95%",
                "alertLevel": "warning"
            },
            "messageLatency": {
                "threshold": "5s",
                "alertLevel": "critical"
            }
        },
        "system": {
            "apiLatency": {
                "threshold": "500ms",
                "alertLevel": "warning"
            },
            "errorRate": {
                "threshold": "1%",
                "alertLevel": "critical"
            }
        }
    }
}
</code></pre>

        <h3>Alerting Strategy</h3>
        <h4>Alert Levels and Escalation</h4>
        <pre><code>// Alert configuration
{
    "alertLevels": {
        "info": {
            "channels": ["dashboard"],
            "escalation": "none"
        },
        "warning": {
            "channels": ["email", "dashboard"],
            "escalation": "30m"
        },
        "critical": {
            "channels": ["sms", "email", "dashboard", "pagerduty"],
            "escalation": "5m"
        }
    },
    "rules": [
        {
            "name": "DeviceOffline",
            "condition": "device.status = 'offline' AND duration > 5m",
            "level": "warning",
            "message": "Device ${deviceId} has been offline for ${duration}"
        }
    ]
}
</code></pre>

        <h2 id="data-management">Data Management</h2>
        <p>Implement effective data management strategies for long-term success.</p>

        <h3>Data Lifecycle Management</h3>
        <h4>Automated Data Tiering</h4>
        <pre><code>// Data lifecycle policy
{
    "lifecycle": {
        "stages": [
            {
                "name": "hot",
                "duration": "30d",
                "storage": "ssd",
                "access": "real-time"
            },
            {
                "name": "warm",
                "duration": "365d",
                "storage": "standard",
                "access": "batch"
            },
            {
                "name": "cold",
                "duration": "2555d",  // 7 years
                "storage": "glacier",
                "access": "archive"
            }
        ]
    }
}
</code></pre>

        <h3>Data Quality</h3>
        <h4>Validation Rules</h4>
        <pre><code>// Data validation configuration
{
    "validation": {
        "temperature": {
            "type": "number",
            "range": [-40, 85],
            "precision": 1,
            "required": true
        },
        "humidity": {
            "type": "number",
            "range": [0, 100],
            "precision": 1,
            "required": true
        },
        "timestamp": {
            "type": "datetime",
            "format": "ISO8601",
            "maxAge": "1h",
            "required": true
        }
    },
    "actions": {
        "onValidationError": "quarantine",
        "onOutOfRange": "flag",
        "onMissingData": "interpolate"
    }
}
</code></pre>

        <h2 id="troubleshooting">Troubleshooting</h2>
        <p>Common issues and their solutions for EdgeSync deployments.</p>

        <h3>Connection Issues</h3>
        <h4>MQTT Connection Failures</h4>
        <div class="alert warning">
            <strong>Common Causes:</strong>
            <ul>
                <li>Invalid certificates or expired credentials</li>
                <li>Network connectivity issues</li>
                <li>Incorrect broker endpoint or port</li>
                <li>ACL permission denied</li>
            </ul>
        </div>

        <h4>Diagnostic Steps</h4>
        <pre><code>// Connection diagnostic script
function diagnoseMQTTConnection() {
    // 1. Check network connectivity
    const pingResult = await ping('mqtt.edgesync.com');
    
    // 2. Verify certificate validity
    const certValid = await validateCertificate(deviceCert);
    
    // 3. Test TLS handshake
    const tlsTest = await testTLSConnection('mqtt.edgesync.com', 8883);
    
    // 4. Check ACL permissions
    const aclTest = await testPublishPermission(deviceId, topic);
    
    return {
        network: pingResult,
        certificate: certValid,
        tls: tlsTest,
        permissions: aclTest
    };
}
</code></pre>

        <h3>Performance Issues</h3>
        <h4>High Latency Troubleshooting</h4>
        <ul>
            <li><strong>Network:</strong> Check bandwidth and packet loss</li>
            <li><strong>Message Size:</strong> Reduce payload size</li>
            <li><strong>QoS Level:</strong> Use appropriate QoS for use case</li>
            <li><strong>Batching:</strong> Implement message batching</li>
        </ul>

        <h2 id="production">Production Deployment</h2>
        <p>Guidelines for deploying EdgeSync solutions in production environments.</p>

        <h3>Environment Configuration</h3>
        <h4>Multi-Environment Setup</h4>
        <pre><code>// Environment configuration
{
    "environments": {
        "development": {
            "mqttBroker": "dev-mqtt.edgesync.com",
            "apiEndpoint": "https://dev-api.edgesync.com",
            "logLevel": "debug",
            "encryption": "optional"
        },
        "staging": {
            "mqttBroker": "staging-mqtt.edgesync.com",
            "apiEndpoint": "https://staging-api.edgesync.com",
            "logLevel": "info",
            "encryption": "required"
        },
        "production": {
            "mqttBroker": "mqtt.edgesync.com",
            "apiEndpoint": "https://api.edgesync.com",
            "logLevel": "error",
            "encryption": "required",
            "monitoring": "enabled"
        }
    }
}
</code></pre>

        <h3>Deployment Checklist</h3>
        <h4>Pre-Production Verification</h4>
        <ul>
            <li>✅ Security audit completed</li>
            <li>✅ Load testing performed</li>
            <li>✅ Monitoring and alerting configured</li>
            <li>✅ Backup and recovery procedures tested</li>
            <li>✅ Documentation updated</li>
            <li>✅ Team training completed</li>
            <li>✅ Incident response plan in place</li>
        </ul>

        <h3>Operational Procedures</h3>
        <h4>Change Management</h4>
        <pre><code>// Deployment pipeline
{
    "pipeline": {
        "stages": [
            {
                "name": "build",
                "actions": ["compile", "test", "security-scan"]
            },
            {
                "name": "staging",
                "actions": ["deploy", "integration-test", "performance-test"]
            },
            {
                "name": "production",
                "actions": ["blue-green-deploy", "health-check", "rollback-ready"]
            }
        ]
    },
    "rollback": {
        "trigger": "health-check-failure",
        "timeout": "5m",
        "notification": ["ops-team", "dev-team"]
    }
}
</code></pre>

        <div class="alert success">
            <strong>Production Ready:</strong> Following these best practices will ensure your EdgeSync deployment is secure, scalable, and maintainable in production environments.
        </div>
    </main>

    <!-- Table of Contents -->
    <aside class="docs-toc">
        <h4>On This Page</h4>
        <ul class="toc-list">
            <!-- TOC will be generated by JavaScript -->
        </ul>
    </aside>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/docs.js' %}"></script>
{% endblock %}
